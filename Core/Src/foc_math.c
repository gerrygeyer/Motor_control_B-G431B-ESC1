/*
 * math.c
 *
 *  Created on: Jul 2, 2024
 *      Author: Gerry Geyer
 */
#include <math.h>
#include <foc_math.h>
#include <stdio.h>
#include <stdlib.h>
#include <foc.h>
#include "parameter.h"

/*
 * Sine Lookup Table [0, pi/2]
 * Number of Points :		1024
 * Maximum Amplitude Value:	32767
 *
 */
const int16_t sineLookupTable90[] = {
		0,50,101,151,201,252,302,352,402,453,503,553,604,654,704,755,805,855,906,956,1006,
		1056,1107,1157,1207,1258,1308,1358,1408,1459,1509,1559,1609,1660,1710,1760,1810,1861,
		1911,1961,2011,2061,2112,2162,2212,2262,2312,2363,2413,2463,2513,2563,2614,2664,2714,
		2764,2814,2864,2914,2964,3015,3065,3115,3165,3215,3265,3315,3365,3415,3465,3515,3565,
		3615,3665,3715,3765,3815,3865,3915,3965,4015,4065,4115,4165,4215,4264,4314,4364,4414,
		4464,4514,4564,4613,4663,4713,4763,4813,4862,4912,4962,5012,5061,5111,5161,5210,5260,
		5310,5359,5409,5459,5508,5558,5607,5657,5706,5756,5806,5855,5905,5954,6003,6053,6102,
		6152,6201,6251,6300,6349,6399,6448,6497,6547,6596,6645,6694,6744,6793,6842,6891,6941,
		6990,7039,7088,7137,7186,7235,7284,7333,7382,7431,7480,7529,7578,7627,7676,7725,7774,
		7823,7872,7921,7969,8018,8067,8116,8164,8213,8262,8311,8359,8408,8456,8505,8554,8602,
		8651,8699,8748,8796,8845,8893,8941,8990,9038,9087,9135,9183,9232,9280,9328,9376,9424,
		9473,9521,9569,9617,9665,9713,9761,9809,9857,9905,9953,10001,10049,10097,10145,10193,
		10240,10288,10336,10384,10431,10479,10527,10574,10622,10669,10717,10765,10812,10860,
		10907,10954,11002,11049,11097,11144,11191,11238,11286,11333,11380,11427,11474,11522,
		11569,11616,11663,11710,11757,11804,11851,11897,11944,11991,12038,12085,12132,12178,
		12225,12272,12318,12365,12411,12458,12505,12551,12597,12644,12690,12737,12783,12829,
		12876,12922,12968,13014,13060,13107,13153,13199,13245,13291,13337,13383,13429,13474,
		13520,13566,13612,13658,13703,13749,13795,13840,13886,13931,13977,14022,14068,14113,
		14159,14204,14249,14295,14340,14385,14430,14476,14521,14566,14611,14656,14701,14746,
		14791,14836,14880,14925,14970,15015,15059,15104,15149,15193,15238,15282,15327,15371,
		15416,15460,15504,15549,15593,15637,15681,15726,15770,15814,15858,15902,15946,15990,
		16034,16078,16121,16165,16209,16253,16296,16340,16383,16427,16471,16514,16557,16601,
		16644,16688,16731,16774,16817,16860,16904,16947,16990,17033,17076,17119,17161,17204,
		17247,17290,17333,17375,17418,17460,17503,17546,17588,17630,17673,17715,17757,17800,
		17842,17884,17926,17968,18010,18052,18094,18136,18178,18220,18262,18304,18345,18387,
		18429,18470,18512,18553,18595,18636,18677,18719,18760,18801,18842,18884,18925,18966,
		19007,19048,19089,19129,19170,19211,19252,19293,19333,19374,19414,19455,19495,19536,
		19576,19616,19657,19697,19737,19777,19817,19857,19897,19937,19977,20017,20057,20097,
		20136,20176,20216,20255,20295,20334,20374,20413,20452,20492,20531,20570,20609,20648,
		20687,20726,20765,20804,20843,20882,20921,20959,20998,21037,21075,21114,21152,21190,
		21229,21267,21305,21344,21382,21420,21458,21496,21534,21572,21610,21647,21685,21723,
		21760,21798,21836,21873,21910,21948,21985,22022,22060,22097,22134,22171,22208,22245,
		22282,22319,22356,22392,22429,22466,22502,22539,22575,22612,22648,22685,22721,22757,
		22793,22829,22865,22901,22937,22973,23009,23045,23081,23116,23152,23188,23223,23259,
		23294,23329,23365,23400,23435,23470,23505,23540,23575,23610,23645,23680,23715,23749,
		23784,23819,23853,23887,23922,23956,23991,24025,24059,24093,24127,24161,24195,24229,
		24263,24297,24330,24364,24398,24431,24465,24498,24532,24565,24598,24631,24665,24698,
		24731,24764,24797,24829,24862,24895,24928,24960,24993,25025,25058,25090,25123,25155,
		25187,25219,25251,25283,25315,25347,25379,25411,25443,25474,25506,25537,25569,25600,
		25632,25663,25694,25725,25757,25788,25819,25850,25881,25911,25942,25973,26003,26034,
		26065,26095,26125,26156,26186,26216,26246,26276,26307,26336,26366,26396,26426,26456,
		26485,26515,26545,26574,26603,26633,26662,26691,26720,26749,26778,26807,26836,26865,
		26894,26923,26951,26980,27008,27037,27065,27094,27122,27150,27178,27206,27234,27262,
		27290,27318,27346,27373,27401,27429,27456,27483,27511,27538,27565,27593,27620,27647,
		27674,27701,27727,27754,27781,27808,27834,27861,27887,27913,27940,27966,27992,28018,
		28044,28070,28096,28122,28148,28174,28199,28225,28250,28276,28301,28327,28352,28377,
		28402,28427,28452,28477,28502,28527,28552,28576,28601,28625,28650,28674,28698,28723,
		28747,28771,28795,28819,28843,28867,28890,28914,28938,28961,28985,29008,29032,29055,
		29078,29101,29124,29147,29170,29193,29216,29239,29262,29284,29307,29329,29352,29374,
		29396,29418,29440,29463,29485,29506,29528,29550,29572,29593,29615,29636,29658,29679,
		29701,29722,29743,29764,29785,29806,29827,29848,29868,29889,29910,29930,29950,29971,
		29991,30011,30032,30052,30072,30092,30111,30131,30151,30171,30190,30210,30229,30249,
		30268,30287,30306,30325,30344,30363,30382,30401,30420,30438,30457,30476,30494,30512,
		30531,30549,30567,30585,30603,30621,30639,30657,30675,30692,30710,30727,30745,30762,
		30779,30797,30814,30831,30848,30865,30882,30898,30915,30932,30948,30965,30981,30998,
		31014,31030,31046,31062,31078,31094,31110,31126,31141,31157,31173,31188,31203,31219,
		31234,31249,31264,31279,31294,31309,31324,31339,31353,31368,31382,31397,31411,31425,
		31440,31454,31468,31482,31496,31510,31523,31537,31551,31564,31578,31591,31604,31618,
		31631,31644,31657,31670,31683,31696,31708,31721,31734,31746,31758,31771,31783,31795,
		31807,31819,31831,31843,31855,31867,31879,31890,31902,31913,31925,31936,31947,31958,
		31969,31980,31991,32002,32013,32024,32034,32045,32055,32066,32076,32086,32096,32106,
		32116,32126,32136,32146,32156,32165,32175,32184,32194,32203,32212,32222,32231,32240,
		32249,32257,32266,32275,32284,32292,32301,32309,32317,32326,32334,32342,32350,32358,
		32366,32374,32381,32389,32397,32404,32412,32419,32426,32433,32441,32448,32455,32462,
		32468,32475,32482,32488,32495,32501,32508,32514,32520,32526,32532,32538,32544,32550,
		32556,32561,32567,32572,32578,32583,32589,32594,32599,32604,32609,32614,32619,32623,
		32628,32633,32637,32642,32646,32650,32654,32659,32663,32667,32670,32674,32678,32682,
		32685,32689,32692,32696,32699,32702,32705,32708,32711,32714,32717,32720,32722,32725,
		32727,32730,32732,32735,32737,32739,32741,32743,32745,32747,32748,32750,32752,32753,
		32754,32756,32757,32758,32759,32760,32761,32762,32763,32764,32765,32765,32766,32766,
		32766,32767,32767,32767,32767
};
/*
 * Sin function:
 * 		Input: theta in int16_t
 * 		Output: sin in int16_t
 */
int16_t sin_t(int16_t y){
	int16_t Output;

	int32_t x_i = ((int32_t)(y * 2048)/ INT16_MAX_VALUE);

	if(x_i < 0){
		x_i = x_i * (-1);
		if(x_i > 1024){
			Output = -sineLookupTable90[(2048 - x_i)];
		}else{
			Output = -sineLookupTable90[x_i];
		}
	}else{
		if(x_i > 1024){
			Output = sineLookupTable90[(2048 - x_i)];
		}else{
			Output = sineLookupTable90[x_i];
		}

	}

	return Output;
}

int16_t cos_t(int16_t y){
	return sin_t(y + INT16_HALF_VALUE);
}



/*
 * create a int16_t value from float. to calculate, use Bitshift >>= 15 after calculation.
 */
int16_t get_INT16_representation(float value){
	return (value * INT16_MAX_VALUE);
}





uint32_t sqrt_fast_uint(uint32_t n) {
    if (n == 0) return 0;

    uint8_t b = 31 - __builtin_clz(n);
    uint32_t x = 1 << (b >> 1); // Initial guess: 2^(b/2)

    x = (x + n / x) >> 1;
    x = (x + n / x) >> 1;
    x = (x + n / x) >> 1;

    if ((uint64_t)x * x > n) x--;

    return x;
}




dq_t circle_limitation_Q15(dq_t Vdq, const uint32_t max_output){
	dq_t Output;

	int32_t x = Vdq.d;
	int32_t y = Vdq.q;

	uint32_t mag = (uint32_t)(x*x) + (uint32_t)(y*y);

	mag = sqrt_fast_uint(mag);

	if(mag == 0){
		Output.d = 0;
		Output.q = 0;
		return (Output);
	}

	if (mag <= max_output) {
		Output.d = Vdq.d;
		Output.q = Vdq.q;
		return Output;
	}

    // 2. Skalenfaktor vorbereiten in Q15: scale = 32767 / |v|
    // Wir rechnen: scale = (32767 << 15) / mag
    uint32_t scale_q15 = (max_output << 15) / mag;
    // 3. norm[i] = (accel[i] * scale_q15) >> 15
    Output.d = CLAMP_INT32_TO_INT16((int32_t)(((int64_t)x * scale_q15) >> 15));
    Output.q = CLAMP_INT32_TO_INT16((int32_t)(((int64_t)y * scale_q15) >> 15));

    return (Output);
}



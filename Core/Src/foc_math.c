/*
 * math.c
 *
 *  Created on: Jul 2, 2024
 *      Author: Gerry Geyer
 */
#include <math.h>
#include <foc_math.h>
#include <stdio.h>
#include <stdlib.h>
#include <foc.h>
#include "parameter.h"

memory_dq IIR_LP;
memory_dq_t IIR_LP_t;
memory_alpha_beta IIR_vLP, IIR_sLP;
float IIR_iq_a = IIR_LP_CURRENT_A;
float memory_iq;
int32_t IIR_LP_a_t, IIR_LP_speed_mem, IIR_LP_speed_a;
float IIR_LP_speed_a_f,IIR_LP_speed_mem_f;

uint8_t circle_flag = 0;

void init_math(void){
	IIR_LP.new.d = 0;
	IIR_LP.new.q = 0;
	IIR_LP.old.d = 0;
	IIR_LP.old.q = 0;

	IIR_LP_t.new.d = 0;
	IIR_LP_t.new.q = 0;
	IIR_LP_t.old.d = 0;
	IIR_LP_t.old.q = 0;

	IIR_vLP.new.alpha = 0;
	IIR_vLP.new.beta = 0;
	IIR_vLP.old.alpha = 0;
	IIR_vLP.old.beta = 0;

	IIR_sLP.new.alpha = 0;
	IIR_sLP.new.beta = 0;
	IIR_sLP.old.alpha = 0;
	IIR_sLP.old.beta = 0;

	memory_iq = 0.0;

	IIR_LP_a_t = 0;
	IIR_LP_speed_a = 112;
	IIR_LP_speed_a_f = 0.112f;
}
/*
 * Sine Lookup Table [0, pi/2]
 * Number of Points :		1024
 * Maximum Amplitude Value:	32767
 *
 */
const int16_t sineLookupTable90[] = {
		0,50,101,151,201,252,302,352,402,453,503,553,604,654,704,755,805,855,906,956,1006,
		1056,1107,1157,1207,1258,1308,1358,1408,1459,1509,1559,1609,1660,1710,1760,1810,1861,
		1911,1961,2011,2061,2112,2162,2212,2262,2312,2363,2413,2463,2513,2563,2614,2664,2714,
		2764,2814,2864,2914,2964,3015,3065,3115,3165,3215,3265,3315,3365,3415,3465,3515,3565,
		3615,3665,3715,3765,3815,3865,3915,3965,4015,4065,4115,4165,4215,4264,4314,4364,4414,
		4464,4514,4564,4613,4663,4713,4763,4813,4862,4912,4962,5012,5061,5111,5161,5210,5260,
		5310,5359,5409,5459,5508,5558,5607,5657,5706,5756,5806,5855,5905,5954,6003,6053,6102,
		6152,6201,6251,6300,6349,6399,6448,6497,6547,6596,6645,6694,6744,6793,6842,6891,6941,
		6990,7039,7088,7137,7186,7235,7284,7333,7382,7431,7480,7529,7578,7627,7676,7725,7774,
		7823,7872,7921,7969,8018,8067,8116,8164,8213,8262,8311,8359,8408,8456,8505,8554,8602,
		8651,8699,8748,8796,8845,8893,8941,8990,9038,9087,9135,9183,9232,9280,9328,9376,9424,
		9473,9521,9569,9617,9665,9713,9761,9809,9857,9905,9953,10001,10049,10097,10145,10193,
		10240,10288,10336,10384,10431,10479,10527,10574,10622,10669,10717,10765,10812,10860,
		10907,10954,11002,11049,11097,11144,11191,11238,11286,11333,11380,11427,11474,11522,
		11569,11616,11663,11710,11757,11804,11851,11897,11944,11991,12038,12085,12132,12178,
		12225,12272,12318,12365,12411,12458,12505,12551,12597,12644,12690,12737,12783,12829,
		12876,12922,12968,13014,13060,13107,13153,13199,13245,13291,13337,13383,13429,13474,
		13520,13566,13612,13658,13703,13749,13795,13840,13886,13931,13977,14022,14068,14113,
		14159,14204,14249,14295,14340,14385,14430,14476,14521,14566,14611,14656,14701,14746,
		14791,14836,14880,14925,14970,15015,15059,15104,15149,15193,15238,15282,15327,15371,
		15416,15460,15504,15549,15593,15637,15681,15726,15770,15814,15858,15902,15946,15990,
		16034,16078,16121,16165,16209,16253,16296,16340,16383,16427,16471,16514,16557,16601,
		16644,16688,16731,16774,16817,16860,16904,16947,16990,17033,17076,17119,17161,17204,
		17247,17290,17333,17375,17418,17460,17503,17546,17588,17630,17673,17715,17757,17800,
		17842,17884,17926,17968,18010,18052,18094,18136,18178,18220,18262,18304,18345,18387,
		18429,18470,18512,18553,18595,18636,18677,18719,18760,18801,18842,18884,18925,18966,
		19007,19048,19089,19129,19170,19211,19252,19293,19333,19374,19414,19455,19495,19536,
		19576,19616,19657,19697,19737,19777,19817,19857,19897,19937,19977,20017,20057,20097,
		20136,20176,20216,20255,20295,20334,20374,20413,20452,20492,20531,20570,20609,20648,
		20687,20726,20765,20804,20843,20882,20921,20959,20998,21037,21075,21114,21152,21190,
		21229,21267,21305,21344,21382,21420,21458,21496,21534,21572,21610,21647,21685,21723,
		21760,21798,21836,21873,21910,21948,21985,22022,22060,22097,22134,22171,22208,22245,
		22282,22319,22356,22392,22429,22466,22502,22539,22575,22612,22648,22685,22721,22757,
		22793,22829,22865,22901,22937,22973,23009,23045,23081,23116,23152,23188,23223,23259,
		23294,23329,23365,23400,23435,23470,23505,23540,23575,23610,23645,23680,23715,23749,
		23784,23819,23853,23887,23922,23956,23991,24025,24059,24093,24127,24161,24195,24229,
		24263,24297,24330,24364,24398,24431,24465,24498,24532,24565,24598,24631,24665,24698,
		24731,24764,24797,24829,24862,24895,24928,24960,24993,25025,25058,25090,25123,25155,
		25187,25219,25251,25283,25315,25347,25379,25411,25443,25474,25506,25537,25569,25600,
		25632,25663,25694,25725,25757,25788,25819,25850,25881,25911,25942,25973,26003,26034,
		26065,26095,26125,26156,26186,26216,26246,26276,26307,26336,26366,26396,26426,26456,
		26485,26515,26545,26574,26603,26633,26662,26691,26720,26749,26778,26807,26836,26865,
		26894,26923,26951,26980,27008,27037,27065,27094,27122,27150,27178,27206,27234,27262,
		27290,27318,27346,27373,27401,27429,27456,27483,27511,27538,27565,27593,27620,27647,
		27674,27701,27727,27754,27781,27808,27834,27861,27887,27913,27940,27966,27992,28018,
		28044,28070,28096,28122,28148,28174,28199,28225,28250,28276,28301,28327,28352,28377,
		28402,28427,28452,28477,28502,28527,28552,28576,28601,28625,28650,28674,28698,28723,
		28747,28771,28795,28819,28843,28867,28890,28914,28938,28961,28985,29008,29032,29055,
		29078,29101,29124,29147,29170,29193,29216,29239,29262,29284,29307,29329,29352,29374,
		29396,29418,29440,29463,29485,29506,29528,29550,29572,29593,29615,29636,29658,29679,
		29701,29722,29743,29764,29785,29806,29827,29848,29868,29889,29910,29930,29950,29971,
		29991,30011,30032,30052,30072,30092,30111,30131,30151,30171,30190,30210,30229,30249,
		30268,30287,30306,30325,30344,30363,30382,30401,30420,30438,30457,30476,30494,30512,
		30531,30549,30567,30585,30603,30621,30639,30657,30675,30692,30710,30727,30745,30762,
		30779,30797,30814,30831,30848,30865,30882,30898,30915,30932,30948,30965,30981,30998,
		31014,31030,31046,31062,31078,31094,31110,31126,31141,31157,31173,31188,31203,31219,
		31234,31249,31264,31279,31294,31309,31324,31339,31353,31368,31382,31397,31411,31425,
		31440,31454,31468,31482,31496,31510,31523,31537,31551,31564,31578,31591,31604,31618,
		31631,31644,31657,31670,31683,31696,31708,31721,31734,31746,31758,31771,31783,31795,
		31807,31819,31831,31843,31855,31867,31879,31890,31902,31913,31925,31936,31947,31958,
		31969,31980,31991,32002,32013,32024,32034,32045,32055,32066,32076,32086,32096,32106,
		32116,32126,32136,32146,32156,32165,32175,32184,32194,32203,32212,32222,32231,32240,
		32249,32257,32266,32275,32284,32292,32301,32309,32317,32326,32334,32342,32350,32358,
		32366,32374,32381,32389,32397,32404,32412,32419,32426,32433,32441,32448,32455,32462,
		32468,32475,32482,32488,32495,32501,32508,32514,32520,32526,32532,32538,32544,32550,
		32556,32561,32567,32572,32578,32583,32589,32594,32599,32604,32609,32614,32619,32623,
		32628,32633,32637,32642,32646,32650,32654,32659,32663,32667,32670,32674,32678,32682,
		32685,32689,32692,32696,32699,32702,32705,32708,32711,32714,32717,32720,32722,32725,
		32727,32730,32732,32735,32737,32739,32741,32743,32745,32747,32748,32750,32752,32753,
		32754,32756,32757,32758,32759,32760,32761,32762,32763,32764,32765,32765,32766,32766,
		32766,32767,32767,32767,32767
};
/*
 * Sin function:
 * 		Input: theta in int16_t
 * 		Output: sin in int16_t
 */
int16_t sin_t(int16_t y){
	int16_t Output;

	int32_t x_i = ((int32_t)(y * 2048)/ INT16_MAX_VALUE);

	if(x_i < 0){
		x_i = x_i * (-1);
		if(x_i > 1024){
			Output = -sineLookupTable90[(2048 - x_i)];
		}else{
			Output = -sineLookupTable90[x_i];
		}
	}else{
		if(x_i > 1024){
			Output = sineLookupTable90[(2048 - x_i)];
		}else{
			Output = sineLookupTable90[x_i];
		}

	}

	return Output;
}

int16_t cos_t(int16_t y){
	return sin_t(y + INT16_HALF_VALUE);
}


/*
 * Sine Lookup Table
 * Number of Points :		1024
 * Maximum Amplitude Value:	65535
 * Numbers Per Line:		10
 * Output Values Type:		Decimal
 * Source: https://deepbluembedded.com/sine-lookup-table-generator-calculator/
 *
 */
const uint16_t sineLookupTable[] = {
32768, 32969, 33170, 33371, 33572, 33773, 33974, 34174, 34375, 34576,
34777, 34977, 35178, 35378, 35579, 35779, 35979, 36179, 36379, 36579,
36779, 36978, 37177, 37377, 37575, 37774, 37973, 38171, 38369, 38567,
38765, 38963, 39160, 39357, 39554, 39751, 39947, 40143, 40339, 40534,
40729, 40924, 41119, 41313, 41507, 41701, 41894, 42087, 42279, 42472,
42663, 42855, 43046, 43237, 43427, 43617, 43807, 43996, 44184, 44373,
44560, 44748, 44935, 45121, 45307, 45493, 45678, 45862, 46046, 46230,
46413, 46595, 46777, 46959, 47140, 47320, 47500, 47679, 47858, 48036,
48214, 48391, 48567, 48743, 48919, 49093, 49267, 49441, 49613, 49785,
49957, 50128, 50298, 50468, 50636, 50805, 50972, 51139, 51305, 51471,
51635, 51799, 51963, 52125, 52287, 52448, 52609, 52768, 52927, 53085,
53243, 53399, 53555, 53710, 53864, 54018, 54170, 54322, 54473, 54623,
54773, 54921, 55069, 55216, 55362, 55507, 55652, 55795, 55938, 56079,
56220, 56360, 56499, 56637, 56775, 56911, 57047, 57181, 57315, 57448,
57579, 57710, 57840, 57969, 58097, 58224, 58350, 58475, 58600, 58723,
58845, 58966, 59087, 59206, 59324, 59441, 59558, 59673, 59787, 59900,
60013, 60124, 60234, 60343, 60451, 60558, 60664, 60769, 60873, 60976,
61078, 61178, 61278, 61377, 61474, 61571, 61666, 61760, 61853, 61945,
62036, 62126, 62215, 62302, 62389, 62474, 62559, 62642, 62724, 62805,
62885, 62963, 63041, 63117, 63192, 63266, 63339, 63411, 63482, 63551,
63620, 63687, 63753, 63818, 63881, 63944, 64005, 64065, 64124, 64182,
64238, 64294, 64348, 64401, 64453, 64504, 64553, 64601, 64648, 64694,
64739, 64782, 64825, 64866, 64905, 64944, 64981, 65018, 65053, 65086,
65119, 65150, 65180, 65209, 65237, 65263, 65289, 65313, 65335, 65357,
65377, 65396, 65414, 65431, 65446, 65460, 65473, 65485, 65496, 65505,
65513, 65520, 65525, 65529, 65533, 65534, 65535, 65534, 65533, 65529,
65525, 65520, 65513, 65505, 65496, 65485, 65473, 65460, 65446, 65431,
65414, 65396, 65377, 65357, 65335, 65313, 65289, 65263, 65237, 65209,
65180, 65150, 65119, 65086, 65053, 65018, 64981, 64944, 64905, 64866,
64825, 64782, 64739, 64694, 64648, 64601, 64553, 64504, 64453, 64401,
64348, 64294, 64238, 64182, 64124, 64065, 64005, 63944, 63881, 63818,
63753, 63687, 63620, 63551, 63482, 63411, 63339, 63266, 63192, 63117,
63041, 62963, 62885, 62805, 62724, 62642, 62559, 62474, 62389, 62302,
62215, 62126, 62036, 61945, 61853, 61760, 61666, 61571, 61474, 61377,
61278, 61178, 61078, 60976, 60873, 60769, 60664, 60558, 60451, 60343,
60234, 60124, 60013, 59900, 59787, 59673, 59558, 59441, 59324, 59206,
59087, 58966, 58845, 58723, 58600, 58475, 58350, 58224, 58097, 57969,
57840, 57710, 57579, 57448, 57315, 57181, 57047, 56911, 56775, 56637,
56499, 56360, 56220, 56079, 55938, 55795, 55652, 55507, 55362, 55216,
55069, 54921, 54773, 54623, 54473, 54322, 54170, 54018, 53864, 53710,
53555, 53399, 53243, 53085, 52927, 52768, 52609, 52448, 52287, 52125,
51963, 51799, 51635, 51471, 51305, 51139, 50972, 50805, 50636, 50468,
50298, 50128, 49957, 49785, 49613, 49441, 49267, 49093, 48919, 48743,
48567, 48391, 48214, 48036, 47858, 47679, 47500, 47320, 47140, 46959,
46777, 46595, 46413, 46230, 46046, 45862, 45678, 45493, 45307, 45121,
44935, 44748, 44560, 44373, 44184, 43996, 43807, 43617, 43427, 43237,
43046, 42855, 42663, 42472, 42279, 42087, 41894, 41701, 41507, 41313,
41119, 40924, 40729, 40534, 40339, 40143, 39947, 39751, 39554, 39357,
39160, 38963, 38765, 38567, 38369, 38171, 37973, 37774, 37575, 37377,
37177, 36978, 36779, 36579, 36379, 36179, 35979, 35779, 35579, 35378,
35178, 34977, 34777, 34576, 34375, 34174, 33974, 33773, 33572, 33371,
33170, 32969, 32768, 32566, 32365, 32164, 31963, 31762, 31561, 31361,
31160, 30959, 30758, 30558, 30357, 30157, 29956, 29756, 29556, 29356,
29156, 28956, 28756, 28557, 28358, 28158, 27960, 27761, 27562, 27364,
27166, 26968, 26770, 26572, 26375, 26178, 25981, 25784, 25588, 25392,
25196, 25001, 24806, 24611, 24416, 24222, 24028, 23834, 23641, 23448,
23256, 23063, 22872, 22680, 22489, 22298, 22108, 21918, 21728, 21539,
21351, 21162, 20975, 20787, 20600, 20414, 20228, 20042, 19857, 19673,
19489, 19305, 19122, 18940, 18758, 18576, 18395, 18215, 18035, 17856,
17677, 17499, 17321, 17144, 16968, 16792, 16616, 16442, 16268, 16094,
15922, 15750, 15578, 15407, 15237, 15067, 14899, 14730, 14563, 14396,
14230, 14064, 13900, 13736, 13572, 13410, 13248, 13087, 12926, 12767,
12608, 12450, 12292, 12136, 11980, 11825, 11671, 11517, 11365, 11213,
11062, 10912, 10762, 10614, 10466, 10319, 10173, 10028, 9883, 9740,
9597, 9456, 9315, 9175, 9036, 8898, 8760, 8624, 8488, 8354,
8220, 8087, 7956, 7825, 7695, 7566, 7438, 7311, 7185, 7060,
6935, 6812, 6690, 6569, 6448, 6329, 6211, 6094, 5977, 5862,
5748, 5635, 5522, 5411, 5301, 5192, 5084, 4977, 4871, 4766,
4662, 4559, 4457, 4357, 4257, 4158, 4061, 3964, 3869, 3775,
3682, 3590, 3499, 3409, 3320, 3233, 3146, 3061, 2976, 2893,
2811, 2730, 2650, 2572, 2494, 2418, 2343, 2269, 2196, 2124,
2053, 1984, 1915, 1848, 1782, 1717, 1654, 1591, 1530, 1470,
1411, 1353, 1297, 1241, 1187, 1134, 1082, 1031, 982, 934,
887, 841, 796, 753, 710, 669, 630, 591, 554, 517,
482, 449, 416, 385, 355, 326, 298, 272, 246, 222,
200, 178, 158, 139, 121, 104, 89, 75, 62, 50,
39, 30, 22, 15, 10, 6, 2, 1, 0, 1,
2, 6, 10, 15, 22, 30, 39, 50, 62, 75,
89, 104, 121, 139, 158, 178, 200, 222, 246, 272,
298, 326, 355, 385, 416, 449, 482, 517, 554, 591,
630, 669, 710, 753, 796, 841, 887, 934, 982, 1031,
1082, 1134, 1187, 1241, 1297, 1353, 1411, 1470, 1530, 1591,
1654, 1717, 1782, 1848, 1915, 1984, 2053, 2124, 2196, 2269,
2343, 2418, 2494, 2572, 2650, 2730, 2811, 2893, 2976, 3061,
3146, 3233, 3320, 3409, 3499, 3590, 3682, 3775, 3869, 3964,
4061, 4158, 4257, 4357, 4457, 4559, 4662, 4766, 4871, 4977,
5084, 5192, 5301, 5411, 5522, 5635, 5748, 5862, 5977, 6094,
6211, 6329, 6448, 6569, 6690, 6812, 6935, 7060, 7185, 7311,
7438, 7566, 7695, 7825, 7956, 8087, 8220, 8354, 8488, 8624,
8760, 8898, 9036, 9175, 9315, 9456, 9597, 9740, 9883, 10028,
10173, 10319, 10466, 10614, 10762, 10912, 11062, 11213, 11365, 11517,
11671, 11825, 11980, 12136, 12292, 12450, 12608, 12767, 12926, 13087,
13248, 13410, 13572, 13736, 13900, 14064, 14230, 14396, 14563, 14730,
14899, 15067, 15237, 15407, 15578, 15750, 15922, 16094, 16268, 16442,
16616, 16792, 16968, 17144, 17321, 17499, 17677, 17856, 18035, 18215,
18395, 18576, 18758, 18940, 19122, 19305, 19489, 19673, 19857, 20042,
20228, 20414, 20600, 20787, 20975, 21162, 21351, 21539, 21728, 21918,
22108, 22298, 22489, 22680, 22872, 23063, 23256, 23448, 23641, 23834,
24028, 24222, 24416, 24611, 24806, 25001, 25196, 25392, 25588, 25784,
25981, 26178, 26375, 26572, 26770, 26968, 27166, 27364, 27562, 27761,
27960, 28158, 28358, 28557, 28756, 28956, 29156, 29356, 29556, 29756,
29956, 30157, 30357, 30558, 30758, 30959, 31160, 31361, 31561, 31762,
31963, 32164, 32365, 32566};


float getSineValue_360(int16_t y) {

	uint16_t y_uint = (uint16_t)y;
	int32_t x_i = (y_uint * 1024) / UINT16_MAX_VALUE;
	uint16_t index = (uint16_t)(x_i);

	int sineValue = sineLookupTable[index];
	// Skaliere den Wert zurück auf den Bereich [-1, 1] // scale back to +-1
	float normalizedSineValue = (float)(sineValue - 32767) / 32767.0f;

	return (normalizedSineValue);

}

float getCosValue_360(int16_t y) {

	uint16_t y_uint = (uint16_t)y;
	y_uint += (UINT16_MAX_VALUE/4); // shift 90 Degree to become sin

	// here its the getSineValue_360() function
	int32_t x_i = (y_uint * 1024) / UINT16_MAX_VALUE;
		uint16_t index = (uint16_t)(x_i);
		int cosineValue = sineLookupTable[index];
		// Skaliere den Wert zurück auf den Bereich [-1, 1]
		float normalizedCosineValue = (float)(cosineValue - 32767) / 32767.0f;

		return (normalizedCosineValue);
}



// simple limit function
float limit_f(float input, float max_value){
	float Output;

	if (input > max_value){
		Output = max_value;
	}
	if (input < -max_value){
		Output = -max_value;
	}
	if (input < max_value && input > -max_value){
		Output = input;
	}

	return (Output);
}
/*
 * create a int16_t value from float. to calculate, use Bitshift >>= 15 after calculation.
 */
int16_t get_INT16_representation(float value){
	return (value * INT16_MAX_VALUE);
}

/*
 * IIR FILTER
 * Source: https://de.mathworks.com/help/mcb/ref/iirfilter.html
 */
dq_f IIR_LP_filter_dq(dq_f I){

	dq_f Output;

	IIR_LP.new.d = IIR_LP_CURRENT_A * I.d + (1 - IIR_LP_CURRENT_A) * IIR_LP.old.d;
	IIR_LP.old.d = IIR_LP.new.d;

	IIR_LP.new.q = IIR_LP_CURRENT_A * I.q + (1 - IIR_LP_CURRENT_A) * IIR_LP.old.q;
	IIR_LP.old.q = IIR_LP.new.q;

	Output.d = IIR_LP.new.d;
	Output.q = IIR_LP.new.q;


	return (Output);
}


alphabeta_f IIR_LP_filter_alpha_beta(alphabeta_f I){

	alphabeta_f Output;

	IIR_vLP.new.alpha = IIR_vLP_CURRENT_A * I.alpha + (1 - IIR_LP_CURRENT_A) * IIR_vLP.old.alpha;
	IIR_vLP.old.alpha = IIR_vLP.new.alpha;

	IIR_vLP.new.beta = IIR_vLP_CURRENT_A * I.beta + (1 - IIR_LP_CURRENT_A) * IIR_vLP.old.beta;
	IIR_vLP.old.beta = IIR_vLP.new.beta;

	Output.alpha = IIR_vLP.new.alpha;
	Output.beta = IIR_vLP.new.beta;


	return (Output);
}

alphabeta_f IIR_LP_filter_observer_alpha_beta(alphabeta_f I, float a){

	alphabeta_f Output;

	IIR_sLP.new.alpha = a * I.alpha + (1 - a) * IIR_sLP.old.alpha;
	IIR_sLP.old.alpha = IIR_sLP.new.alpha;

	IIR_sLP.new.beta = a * I.beta + (1 - a) * IIR_vLP.old.beta;
	IIR_sLP.old.beta = IIR_sLP.new.beta;

	Output.alpha = IIR_sLP.new.alpha;
	Output.beta = IIR_sLP.new.beta;


	return (Output);
}

float IIR_LP_filter_Iq_set(float iq){

	float Output,a;

	a = IIR_iq_a;

	Output = a * iq + (1 - a) * memory_iq;
	memory_iq = Output;

	return Output;
}

int16_t IIR_LP_filter_Speed(int16_t input){
	int16_t Output;

	Output = (IIR_LP_speed_a * input + (1000 - IIR_LP_speed_a) * IIR_LP_speed_mem)/1000;
	IIR_LP_speed_mem = Output;

	return (Output);
}
int16_t IIR_LP_filter_Speed_f(int16_t input){
	int16_t Output;

	Output = (int16_t)(IIR_LP_speed_a_f * (float)input + (1.0f - IIR_LP_speed_a_f) * IIR_LP_speed_mem_f);
	IIR_LP_speed_mem_f = (float)Output;

	return (Output);
}

dq_f circle_limiter_maxVoltage(dq_f v_12){

	dq_f Output, V;
	float v_ref;


	if(v_12.d > MAX_VOLTAGE){
		v_12.d = MAX_VOLTAGE;
	}
	if(v_12.d < -MAX_VOLTAGE){
		v_12.d = -MAX_VOLTAGE;
	}
	if(v_12.q > MAX_VOLTAGE){
		v_12.q = MAX_VOLTAGE;
	}
	if(v_12.q < -MAX_VOLTAGE){
		v_12.q = -MAX_VOLTAGE;
	}

	V.d = v_12.d / MAX_VOLTAGE;
	V.q = v_12.q / MAX_VOLTAGE;

	v_ref = eucl_norm2_approx(V.d, V.q);
//	float test = eucl_norm2_approx_int(V.d, V.q);

		// Limit Vector in circle
		if (v_ref > 1.0f){
			Output.d = (v_12.d / v_ref);
			Output.q = (v_12.q / v_ref);
		}else{
			Output.d = v_12.d;
			Output.q = v_12.q;
		}

	return (Output);

}



/*
 * Approximation of eucl_norm2
 * https://math.stackexchange.com/questions/3742642/a-simple-estimation-approximation-of-square-root
 */

float eucl_norm2_approx(float x, float y){

	float Output;
	float a,b,a_2,b_2,a_4,b_4,u_1, u_2, u_3,u,v_1, v_2,v;

	// sorting by size
	a = (x>y)? x:y;
	b = (x>y)? y:x;


	a_2 = a * a;
	b_2 = b * b;
	a_4 = a_2 * a_2;
	b_4 = b_2 * b_2;

	u_1 = 5*b_4;
	u_2 = (20 * a_2 * b_2);
	u_3 = 16 * a_4;
	u = a * (u_1 + u_2 + u_3);

	v_1 = (12 * a_2 *b_2);
	v_2 = 16 * a_4;
	v = b_4 + v_1 + v_2;

	Output = u/v;

	return Output;
}

uint32_t sqrt_fast_uint(uint32_t n) {
    if (n == 0) return 0;

    uint8_t b = 31 - __builtin_clz(n);
    uint32_t x = 1 << (b >> 1); // Initial guess: 2^(b/2)

    x = (x + n / x) >> 1;
    x = (x + n / x) >> 1;
    x = (x + n / x) >> 1;

    if ((uint64_t)x * x > n) x--;

    return x;
}




dq_t circle_limitation_Q15(dq_t Vdq, const uint32_t max_output){
	dq_t Output;

	int32_t x = Vdq.d;
	int32_t y = Vdq.q;

	uint32_t mag = (uint32_t)(x*x) + (uint32_t)(y*y);

	mag = sqrt_fast_uint(mag);

	if(mag == 0){
		Output.d = 0;
		Output.q = 0;
		return (Output);
	}

	if (mag <= max_output) {
		Output.d = Vdq.d;
		Output.q = Vdq.q;
		return Output;
	}

    // 2. Skalenfaktor vorbereiten in Q15: scale = 32767 / |v|
    // Wir rechnen: scale = (32767 << 15) / mag
    uint32_t scale_q15 = (max_output << 15) / mag;
    // 3. norm[i] = (accel[i] * scale_q15) >> 15
    Output.d = CLAMP_INT32_TO_INT16((int32_t)(((int64_t)x * scale_q15) >> 15));
    Output.q = CLAMP_INT32_TO_INT16((int32_t)(((int64_t)y * scale_q15) >> 15));

    return (Output);
}


